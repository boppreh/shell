<html>
<head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
body {
    /*background-color: #101012;*/
    /*color: #BFB;*/
    font: 12px courier,sans-serif;
}

input {
    font: inherit;
    color: inherit;
}

#btn-new-block {
    position: fixed;
    right: 10px;
    bottom: 10px;
}

.input-part {
    margin-left: 5px;
    padding: 1px 3px;
    background: #EEE;
    font-weight: bold;
}

button {
    margin: 0px 5px;
}

.result {
    border-left: 2px solid;
    padding-left: 4px;
    margin-top: 3px;
    margin-bottom: 10px;
    white-space: pre;
}

.block-number {
    color: #000;
    font: bold 14px sans-serif;
}
    </style>
    <script>
function setupMouseResize(img) {
    img.draggable = false;
    img.onmousedown = function(e) {
        img.initialWidth = img.width;
        img.initialHeight = img.height;
        function onmove(e2) {
            var scale = Math.max(0.01, Math.min(e2.clientX / e.clientX, e2.clientY / e.clientY));

            img.width = scale * img.initialWidth;
            img.height = scale * img.initialHeight;
        }
        function onup() {
            window.removeEventListener('mousemove', onmove);
            window.removeEventListener('mouseup', onup);
        }
        window.addEventListener('mousemove', onmove);
        window.addEventListener('mouseup', onup);
    }
}

function newPart() {
    var part = document.createElement('span');
    part.classList.add('input-part')
    part.onclick = function(e) {
        if (input.parentNode !== null) {
            var replacement = newPart();
            replacement.innerText = input.value;
            input.parentNode.replaceChild(replacement, input);
        }
        input.value = part.innerText;
        part.parentNode.replaceChild(input, part);
        input.focus();
        input.select();
    }
    return part;
}

var input = document.createElement('input');
input.classList.add('input-part')
input.type = 'text';
input.onkeydown = function(e) {
    var block = input.parentNode.parentNode;

    if (e.which === 9) {
        e.preventDefault();
        if (!e.shiftKey) {
            if (!input.nextSibling) {
                input.parentNode.appendChild(newPart());
            }
            input.nextSibling.onclick();
        } else {
            input.previousSibling && input.previousSibling.onclick();
        }
    }
    if (e.which === 13) {
        block.run();
        newBlock();
    }
    if (e.which == 38) {
        block.previousSibling.children[2].children[0].onclick();
        e.preventDefault();
    } else if (e.which == 40) {
        block.nextSibling.children[2].children[0].onclick();
        e.preventDefault();
    }

    if (e.which === 27) {
        block.nextSibling.children[2].children[0].onclick();
        block.remove();
        e.preventDefault();
    }
}

function newBlock(number, inputParts, runCached) {
    var block = document.createElement('div');
    block.number = number || document.body.lastChild.number + 1 || 1;

    var number = document.createElement('span');
    number.innerText = '#' + block.number;
    number.classList.add('block-number');
    block.appendChild(number);

    var remove = document.createElement('button');
    remove.classList.add('remove');
    remove.innerText = 'x'
    block.appendChild(remove);
    block.remove = remove.onclick = function() {
        block.parentNode.removeChild(block);
        var client = new XMLHttpRequest();
        client.open('GET', '/remove/' + block.number);
        client.send();
    }

    var inSpan = document.createElement('span');
    block.appendChild(inSpan);

    var run = document.createElement('button');
    run.classList.add('run');
    run.innerText = '>'
    block.appendChild(run);

    var download = document.createElement('a');
    download.href = '/outputs/' + block.number;
    download.download = block.number;
    download.classList.add('download');
    download.innerText = 'download';
    download.style.display = 'none';
    block.appendChild(download);

    var result = document.createElement('div');
    result.classList.add('result');
    result.id = 'result' + block.number;
    block.appendChild(result);

    block.run = run.onclick = function() {
        var parts = [];
        for (var i = 0; i < inSpan.children.length; i++) {
            var child = inSpan.children[i];
            parts.push(child.innerText || child.value);
        }
        document.title = parts.join(' ');

        var formData = new FormData();
        formData.append('data', JSON.stringify({id: block.number, parts: parts, cached: runCached}));
        var request = new XMLHttpRequest();
        request.open('POST', '/run', true);
        while (result.children.length) {
            result.remove(result.children[0]);
        }
        number.style.color = '#000';
        request.onreadystatechange = function(e) {
            var header = request.getResponseHeader('Content-Type');
            if (header === null) return;

            var type = header.split('/')[0];

            if (type === 'text') {
                if (request.readyState < 4) return;
                result.innerText = request.responseText;
            } else {
                if (request.readyState !== 2) return;
                request.abort();
                var media;
                if (type === 'image') {
                    media = document.createElement('img');
                    setupMouseResize(media);
                } else if (type === 'video') {
                    media = document.createElement('video');
                    media.controls = true;
                } else if (type === 'audio') {
                    media = document.createElement('audio');
                    media.controls = true;
                } else {
                    alert('Unknown media type ' + header);
                }
                media.src = '/outputs/' + block.number;
                result.appendChild(media);
            }
            download.style.display = 'inline';
            number.style.color = '#0B0';
            input.scrollIntoView();
        };
        request.send(formData);
    }
    number.onclick = function() {
        if (result.style.display == 'none')
            result.style.display = 'block';
        else
            result.style.display = 'none';
    }

    document.body.appendChild(block);

    if (inputParts === undefined) {
        var first = newPart();
        inSpan.appendChild(first);
        first.onclick();
    } else {
        for (var i = 0; i < inputParts.length; i++) {
            var part = newPart();
            part.innerText = inputParts[i];
            inSpan.appendChild(part);
        }
        if (runCached) {
            block.run();
            runCached = false;
        }
    }
}
function loadSession() {
    var client = new XMLHttpRequest();
    client.open('GET', '/session');
    client.onreadystatechange = function() {
        if (client.readyState < 4) {
            return;
        }

        var session = JSON.parse(client.responseText);
        for (var id in session) {
            newBlock(id|0, session[id], true);
        }

        newBlock();
    }
    client.send();
}
window.onload = function() {
    var newBlockButton = document.createElement('button');
    newBlockButton.innerText = '+';
    newBlockButton.id = 'btn-new-block';
    document.body.appendChild(newBlockButton);
    newBlockButton.onclick = function(e) { newBlock() };

    loadSession();
};
    </script>
</head>
<body>
</body>
</html>