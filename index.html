<html>
<head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
body {
    background-color: #111;
    color: #EEE;
    font: 12px courier,sans-serif;
    line-height: 0.9em;
    margin: 0px;
    padding: 0px;
}

a {
    color: inherit;
}

.input-part {
    margin: 0px 3px;
    padding: 0px 3px;
    min-width: 10px;
    background-color: #222;
    font-weight: bold;
}

.result {
    margin-top: 3px;
    margin-bottom: 10px;
    white-space: pre;
    word-wrap: break-word;
}

.block-number {
    color: #55F;
    font: bold 12px sans-serif;
}
    </style>
    <script>
function setupInlineMedia(media) {
    media.autoplay = true;
    media.loop = true;
    media.controls = false;
    media.muted = true;

    media.onloadeddata = media.onload = function() {
        media.width = media.width || media.videoWidth;
        media.height = media.height || media.videoHeight;
        var originalWidth = media.width;
        var originalHeight = media.height;
        media.width = Math.min(media.width, window.innerWidth);
        media.height = Math.min(media.height, window.innerHeight);
        var scale = Math.min(media.width / originalWidth, media.height / originalHeight);
        media.width = originalWidth * scale;
        media.height = originalHeight * scale;
    };

    media.draggable = false;
    media.style.cursor = 'hand';
    media.onmousedown = function(e) {
        media.initialWidth = media.width;
        media.initialHeight = media.height;
        function onmove(e2) {
            var scaleX = e2.clientX / e.clientX;
            var scaleY = e2.clientY / e.clientY;
            var scale = Math.max(0.01, Math.min(scaleX, scaleY));

            media.width = scale * media.initialWidth;
            media.height = scale * media.initialHeight;
        }
        function onup(e2) {
            window.removeEventListener('mousemove', onmove);
            window.removeEventListener('mouseup', onup);
            e2.preventDefault();
            e2.stopPropagation();
            e2.stopImmediatePropagation();
        }
        window.addEventListener('mousemove', onmove);
        window.addEventListener('mouseup', onup);
    }
}

function POST(path, formData, onFinished) {
    var request = new XMLHttpRequest();
    request.open('POST', path, true);
    request.onreadystatechange = function(e) {
        if (request.readyState >= 4) {
            onFinished(request.responseText);
        }
    };
    request.send(formData);
}

function showContents(path, result, onFinished) {
    var request = new XMLHttpRequest();
    request.open('GET', path, true);

    request.onreadystatechange = function(e) {
        var header = request.getResponseHeader('Content-Type');
        if (header === null) return;

        var type = header.split('/')[0];

        if (type === 'text') {
            if (request.readyState < 4) return;
            if (request.responseText === '') {
                result.style.display == 'none';
            } else {
                result.style.display == 'block';
            }
            result.innerText = request.responseText;
            onFinished && onFinished();
        } else {
            request.abort();
            var media;
            if (type === 'image') {
                media = document.createElement('img');
                setupInlineMedia(media);
            } else if (type === 'video' || path.endsWith('.webm')) {
                media = document.createElement('video');
                setupInlineMedia(media);
            } else if (type === 'audio') {
                media = document.createElement('audio');
                media.controls = true;
            } else {
                alert('Unknown media type ' + header);
            }
            media.src = path;
            result.appendChild(media);
            onFinished && onFinished();
        }
    };

    request.send();
}

function showGallery(path, finalResult) {
    POST(path, undefined, function(text) {
        var lines = text.split('\n');
        for (var i = 0; i < lines.length; i++) {
            var subResult = document.createElement('div');
            finalResult.appendChild(subResult);
            showContents('file?path=' + lines[i], subResult);
        }
    });
}

function selectNewBlock() {
    var lastBlock = document.getElementById('blocks').lastChild;
    if (!lastBlock) {
        return newBlock();
    }

    var lastFirstPart = lastBlock.inSpan.firstChild;
    if (lastFirstPart.innerText === '') {
        lastFirstPart.focus();
        lastFirstPart.scrollIntoView();
    } else {
        newBlock();
    }
}

function newInputPart(block, text) {
    var part = document.createElement('span');
    part.classList.add('input-part');
    part.contentEditable = true;
    part.innerText = text || '';
    part.onfocus = function(e) {
        
    }
    part.onkeydown = function(e) {
        if (e.ctrlKey && e.which !== 13) {
            return;
        }

        if (e.which === 9) {
            if (!e.shiftKey && !part.nextSibling) {
                part.insertAdjacentElement('afterEnd', newInputPart(block));
            }
            if (e.shiftKey) {
                if (!part.previousSibling) {
                    e.preventDefault();
                } else if (part.innerText === '') {
                    part.previousSibling.focus();
                    part.parentNode.removeChild(part);
                    e.preventDefault();
                }
            }
        }
        if (e.which === 13) {
            if (e.ctrlKey) {
                var firstPart = block.inSpan.firstChild;
                if (firstPart.innerText[0] !== '@') {
                    firstPart.innerText = '@' + firstPart.innerText;
                }
            }
            e.preventDefault();
            block.run();
            selectNewBlock();
        }
        if (e.which === 27) {
            var prev = block.previousSibling;
            var next = block.nextSibling;
            block.remove();
            if (prev) {
                prev.inSpan.firstChild.focus();
            } else if (next) {
                next.inSpan.firstChild.focus();
            } else {
                selectNewBlock();
            }
        }
        if (e.which === 38) {
            block.previousSibling && block.previousSibling.inSpan.firstChild.focus();
        } else if (e.which === 40) {
            if (block.nextSibling) {
                block.nextSibling.inSpan.firstChild.focus();
            } else {
                selectNewBlock();
            }
        }
    };
    return part;
}

function newBlock(number, inputParts, submitted) {
    var block = document.createElement('div');
    var lastBlock = document.getElementById('blocks').lastChild;
    block.number = number || (lastBlock && lastBlock.number + 1) || 1;
    block.submitted = submitted;

    var number = document.createElement('span');
    number.innerText = '#' + block.number;
    number.classList.add('block-number');
    block.appendChild(number);

    block.remove = function() {
        if (block.submitted) {
            var client = new XMLHttpRequest();
            client.open('GET', '/remove/' + block.number);
            client.send();
        }
        block.parentNode.removeChild(block);
    };

    var inSpan = document.createElement('span');
    block.inSpan = inSpan;
    if (inputParts === undefined) {
        inputParts = [''];
    }
    for (var i = 0; i < inputParts.length; i++) {
        inSpan.appendChild(newInputPart(block, inputParts[i]));
    }
    block.appendChild(inSpan);

    var download = document.createElement('a');
    download.href = '/outputs/' + block.number;
    download.download = block.number;
    download.classList.add('download');
    download.innerText = 'download';
    download.style.display = 'none';
    download.tabIndex = -1;
    block.appendChild(download);

    var result = document.createElement('div');
    result.classList.add('result');
    result.id = 'result' + block.number;
    block.appendChild(result);

    block.onSubmitted = function() {
        download.style.display = 'inline';
        number.style.color = '#5F5';
        selectNewBlock();
    }

    block.run = function() {
        var parts = [];
        for (var i = 0; i < inSpan.children.length; i++) {
            parts.push(inSpan.children[i].innerText);
        }
        if (parts.length === 1 && parts[0] === '') {
            return;
        }
        document.title = parts.join(' ');

        for (var i = result.children.length - 1; i >= 0; i--) {
            result.remove(result.children[i]);
        }
        number.style.color = '#F55';

        if (parts.length === 1 && parts[0][0] == '!') {
            var path = parts[0].slice(1);
            if (parts[0].indexOf('*') === -1) {
                showContents('file?path=' + path, result);
            } else {
                showGallery('glob?path=' + path, result);
            }
            return;
        }

        var formData = new FormData();
        formData.append('data', JSON.stringify({
            id: block.number,
            parts: parts,
        }));
        POST('run', formData, function(text) {
            result.innerText = text;
            block.onSubmitted();
            selectNewBlock();
        });

        block.submitted = true;
    }
    number.onclick = function() {
        result.style.display = result.style.display == 'none' ? 'block'  : 'none';
    }

    if (block.submitted) {
        showContents('outputs/' + block.number, result, block.onSubmitted);
    }

    document.getElementById('blocks').appendChild(block);
    inSpan.firstChild.focus();
}
function loadSession() {
    var client = new XMLHttpRequest();
    client.open('GET', '/session');
    client.onreadystatechange = function() {
        if (client.readyState < 4) {
            return;
        }

        var session = JSON.parse(client.responseText);
        for (var id in session) {
            newBlock(id|0, session[id], true);
        }

        newBlock(0, [''], false);
    }
    client.send();
}
window.onload = function() {
    loadSession();
    window.onkeydown = function(e) {
        if (e.which === 32 && !e.target.classList.contains('input-part')) {
            e.preventDefault();
            selectNewBlock();
        }
    };
};
    </script>
</head>
<body>
<div id="blocks"></div>
<div id="controls"></div>
</body>
</html>