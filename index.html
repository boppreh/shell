<html>
<head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
body {
    /*background-color: #101012;*/
    /*color: #BFB;*/
    font: 12px courier,sans-serif;
}

input {
    font: inherit;
    color: inherit;
}

#btn-new-block {
    position: fixed;
    right: 10px;
    bottom: 10px;
}

.input-part {
    margin-left: 5px;
    padding: 1px 3px;
    background: #EEE;
    font-weight: bold;
}

button {
    margin: 0px 5px;
}

.result {
    border-left: 2px solid;
    padding-left: 4px;
    margin-top: 3px;
    margin-bottom: 10px;
    white-space: pre;
    word-wrap: break-word;
}

.block-number {
    color: #000;
    font: bold 14px sans-serif;
}
    </style>
    <script>
function setupInlineMedia(media) {
    media.autoplay = true;
    media.loop = true;
    media.controls = false;
    media.muted = true;

    media.onloadeddata = media.onload = function() {
        media.width = media.width || media.videoWidth;
        media.height = media.height || media.videoHeight;
        var originalWidth = media.width;
        var originalHeight = media.height;
        media.width = Math.min(media.width, window.innerWidth);
        media.height = Math.min(media.height, window.innerHeight);
        var scale = Math.min(media.width / originalWidth, media.height / originalHeight);
        media.width = originalWidth * scale;
        media.height = originalHeight * scale;
        console.log(scale);
    };

    media.draggable = false;
    media.style.cursor = 'hand';
    media.onmousedown = function(e) {
        media.initialWidth = media.width;
        media.initialHeight = media.height;
        function onmove(e2) {
            var scaleX = e2.clientX / e.clientX;
            var scaleY = e2.clientY / e.clientY;
            var scale = Math.max(0.01, Math.min(scaleX, scaleY));

            media.width = scale * media.initialWidth;
            media.height = scale * media.initialHeight;
        }
        function onup(e2) {
            window.removeEventListener('mousemove', onmove);
            window.removeEventListener('mouseup', onup);
            e2.preventDefault();
            e2.stopPropagation();
            e2.stopImmediatePropagation();
        }
        window.addEventListener('mousemove', onmove);
        window.addEventListener('mouseup', onup);
    }
}

function newPart() {
    var part = document.createElement('span');
    part.classList.add('input-part')
    part.onclick = function(e) {
        if (input.parentNode !== null) {
            var replacement = newPart();
            replacement.innerText = input.value;
            input.parentNode.replaceChild(replacement, input);
        }
        input.value = part.innerText;
        part.parentNode.replaceChild(input, part);
        input.focus();
        input.select();
    }
    return part;
}

var input = document.createElement('input');
input.classList.add('input-part')
input.type = 'text';
input.onkeydown = function(e) {
    var block = input.parentNode.parentNode;

    if (e.which === 9) {
        e.preventDefault();
        if (!e.shiftKey) {
            if (!input.nextSibling) {
                input.parentNode.appendChild(newPart());
            }
            input.nextSibling.onclick();
        } else {
            input.previousSibling && input.previousSibling.onclick();
        }
    }
    if (e.which === 13) {
        block.run();
        newBlock();
    }
    if (e.which == 38 && block.previousSibling) {
        block.previousSibling.select();
        e.preventDefault();
    } else if (e.which == 40 && block.nextSibling) {
        block.nextSibling.select();
        e.preventDefault();
    }

    if (e.which === 27) {
        block.remove();
        e.preventDefault();
    }
}

function POST(path, formData, onFinished) {
    var request = new XMLHttpRequest();
    request.open('POST', path, true);
    request.onreadystatechange = function(e) {
        if (request.readyState >= 4) {
            onFinished(request.responseText);
        }
    };
    request.send(formData);
}

function showContents(path, result, onFinished) {
    var request = new XMLHttpRequest();
    request.open('GET', path, true);

    request.onreadystatechange = function(e) {
        var header = request.getResponseHeader('Content-Type');
        if (header === null) return;

        var type = header.split('/')[0];

        if (type === 'text') {
            if (request.readyState < 4) return;
            if (request.responseText === '') {
                result.style.display == 'none';
            } else {
                result.style.display == 'block';
            }
            result.innerText = request.responseText;
            onFinished && onFinished();
        } else {
            request.abort();
            var media;
            if (type === 'image') {
                media = document.createElement('img');
                setupInlineMedia(media);
            } else if (type === 'video' || path.endsWith('.webm')) {
                media = document.createElement('video');
                setupInlineMedia(media);
            } else if (type === 'audio') {
                media = document.createElement('audio');
                media.controls = true;
            } else {
                alert('Unknown media type ' + header);
            }
            media.src = path;
            result.appendChild(media);
            onFinished && onFinished();
        }
    };

    request.send();
}

function showGallery(path, finalResult) {
    POST(path, undefined, function(text) {
        var lines = text.split('\n');
        for (var i = 0; i < lines.length; i++) {
            var subResult = document.createElement('div');
            finalResult.appendChild(subResult);
            showContents('file?path=' + lines[i], subResult);
        }
    });
}

function newBlock(number, inputParts, submitted) {
    var block = document.createElement('div');
    var lastBlock = document.getElementById('blocks').lastChild;
    block.number = number || (lastBlock && lastBlock.number + 1) || 1;
    block.submitted = submitted;

    var number = document.createElement('span');
    number.innerText = '#' + block.number;
    number.classList.add('block-number');
    block.appendChild(number);

    var remove = document.createElement('button');
    remove.classList.add('remove');
    remove.innerText = 'x'
    block.appendChild(remove);
    block.remove = remove.onclick = function() {
        if (inSpan.contains(input)) {
            if (block.parentNode.lastChild !== block) {
                block.nextSibling.select();
            } else if (block.parentNode.firstChild !== block) {
                block.previousSibling.select();
            } else {
                newBlock();
            }
        }
        block.parentNode.removeChild(block);
        if (block.submitted) {
            var client = new XMLHttpRequest();
            client.open('GET', '/remove/' + block.number);
            client.send();
        }
    }

    var inSpan = document.createElement('span');
    block.appendChild(inSpan);

    var run = document.createElement('button');
    run.classList.add('run');
    run.innerText = '>'
    block.appendChild(run);

    var download = document.createElement('a');
    download.href = '/outputs/' + block.number;
    download.download = block.number;
    download.classList.add('download');
    download.innerText = 'download';
    download.style.display = 'none';
    block.appendChild(download);

    var result = document.createElement('div');
    result.classList.add('result');
    result.id = 'result' + block.number;
    block.appendChild(result);

    block.showOutput = function() {
        showContents('outputs/' + block.number, result, function(isEmpty) {
            download.style.display = isEmpty ? 'none' : 'inline';
            number.style.color = '#0B0';
            input.scrollIntoView();
        });
    };
    block.run = run.onclick = function() {
        var parts = [];
        for (var i = 0; i < inSpan.children.length; i++) {
            var child = inSpan.children[i];
            parts.push(child.innerText || child.value);
        }
        if (parts.length === 1 && parts[0] === '') {
            return;
        }
        document.title = parts.join(' ');

        while (result.firstChild) result.remove(result.firstChild);
        number.style.color = '#000';

        if (parts.length === 1 && parts[0][0] == '!') {
            var path = parts[0].slice(1);
            if (parts[0].indexOf('*') === -1) {
                showContents('file?path=' + path, result);
            } else {
                showGallery('glob?path=' + path, result);
            }
            return;
        }

        var formData = new FormData();
        formData.append('data', JSON.stringify({
            id: block.number,
            parts: parts,
        }));
        POST('run', formData, block.showOutput);

        block.submitted = true;
    }
    number.onclick = function() {
        if (result.style.display == 'none')
            result.style.display = 'block';
        else
            result.style.display = 'none';
    }

    document.getElementById('blocks').appendChild(block);

    if (inputParts === undefined) {
        var first = newPart();
        inSpan.appendChild(first);
        first.onclick();
    } else {
        for (var i = 0; i < inputParts.length; i++) {
            var part = newPart();
            part.innerText = inputParts[i];
            inSpan.appendChild(part);
        }
        if (submitted) {
            block.showOutput();
        }
    }
    block.select = function() { inSpan.firstChild.onclick() };
}
function loadSession() {
    var client = new XMLHttpRequest();
    client.open('GET', '/session');
    client.onreadystatechange = function() {
        if (client.readyState < 4) {
            return;
        }

        var session = JSON.parse(client.responseText);
        for (var id in session) {
            newBlock(id|0, session[id], true);
        }

        newBlock();
    }
    client.send();
}
window.onload = function() {
    var newBlockButton = document.createElement('button');
    newBlockButton.innerText = '+';
    newBlockButton.id = 'btn-new-block';
    document.getElementById('controls').appendChild(newBlockButton);
    newBlockButton.onclick = function(e) { newBlock() };

    loadSession();
};
    </script>
</head>
<body>
<div id="blocks"></div>
<div id="controls"></div>
</body>
</html>